<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé¨ CineStelar - Cat√°logo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a2e 100%);
            color: #fff;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid #333;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #e50914;
            text-decoration: none;
        }

        .search-box {
            flex: 1;
            max-width: 400px;
            min-width: 200px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 15px;
            border: none;
            border-radius: 20px;
            background: #333;
            color: #fff;
            font-size: 14px;
        }

        .search-box input::placeholder {
            color: #888;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 5px;
        }

        .nav-item {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background: transparent;
            color: #888;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .nav-item:hover {
            color: #fff;
            background: #333;
        }

        .nav-item.active {
            background: #e50914;
            color: #fff;
        }

        .nav-item .count {
            margin-left: 5px;
            font-size: 12px;
            opacity: 0.8;
        }

        /* Main Content */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .section-title {
            font-size: 20px;
            margin: 30px 0 15px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Grid de Cards */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        /* Card */
        .card {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            aspect-ratio: 2/3;
            background: #1a1a1a;
        }

        .card:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(229, 9, 20, 0.3);
            z-index: 10;
        }

        .card-poster {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .card-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            padding: 10px;
        }

        .card-placeholder-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .card-placeholder-title {
            font-size: 12px;
            text-align: center;
            color: #888;
            word-break: break-word;
        }

        .card-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            z-index: 2;
        }

        .badge-movie {
            background: #e50914;
        }

        .badge-series {
            background: #0078d4;
        }

        .card-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 40px 10px 10px;
            background: linear-gradient(transparent, rgba(0,0,0,0.9));
        }

        .card-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-meta {
            display: flex;
            gap: 8px;
            font-size: 11px;
            color: #888;
        }

        .card-meta .rating {
            color: #ffd700;
        }

        /* Loading & Empty States */
        .loading, .empty {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #333;
            border-top-color: #e50914;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        /* Modal */
        .modal-bg {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-bg.show {
            display: flex;
        }

        .modal {
            background: #181818;
            border-radius: 12px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(0,0,0,0.7);
            color: #fff;
            border: none;
            font-size: 24px;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-backdrop {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: 12px 12px 0 0;
        }

        .modal-backdrop-placeholder {
            width: 100%;
            height: 300px;
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 80px;
            border-radius: 12px 12px 0 0;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-header {
            display: flex;
            gap: 20px;
            margin-top: -80px;
            position: relative;
            z-index: 5;
        }

        .modal-poster {
            width: 150px;
            height: 225px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            flex-shrink: 0;
        }

        .modal-info {
            padding-top: 90px;
        }

        .modal-info h2 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .modal-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            color: #888;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .modal-meta .rating {
            color: #ffd700;
        }

        .modal-genres {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .genre-tag {
            padding: 5px 10px;
            background: #333;
            border-radius: 4px;
            font-size: 12px;
        }

        .modal-overview {
            color: #d2d2d2;
            line-height: 1.6;
            font-size: 14px;
            margin-top: 20px;
        }

        /* Bot√≥n Ver Ahora */
        .watch-btn {
            margin-top: 20px;
            padding: 14px 28px;
            background: linear-gradient(135deg, #e50914 0%, #b20710 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(229, 9, 20, 0.4);
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .watch-btn:hover {
            background: linear-gradient(135deg, #ff0a16 0%, #e50914 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(229, 9, 20, 0.6);
        }

        .watch-btn:active {
            transform: translateY(0);
        }

        @media (max-width: 600px) {
            .header-content {
                flex-direction: column;
            }
            .search-box {
                width: 100%;
                max-width: none;
            }
            .modal-header {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            .modal-info {
                padding-top: 10px;
            }
            .modal-info h2 {
                font-size: 22px;
            }
            .watch-btn {
                width: 100%;
                justify-content: center;
            }
            .grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="#" class="logo">üé¨ CineStelar</a>
            <div class="search-box">
                <input type="text" id="search" placeholder="üîç Buscar pel√≠culas y series...">
            </div>
            <nav class="nav-tabs">
                <button class="nav-item active" data-tab="all">
                    Todo <span class="count" id="countAll">0</span>
                </button>
                <button class="nav-item" data-tab="movies">
                    Pel√≠culas <span class="count" id="countMovies">0</span>
                </button>
                <button class="nav-item" data-tab="series">
                    Series <span class="count" id="countSeries">0</span>
                </button>
            </nav>
        </div>
    </header>

    <main class="container">
        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Cargando cat√°logo...</p>
        </div>

        <!-- Empty State -->
        <div class="empty" id="empty" style="display: none;">
            <div class="empty-icon">üé¨</div>
            <h3>No se encontraron resultados</h3>
            <p>Intenta con otra b√∫squeda</p>
        </div>

        <!-- Movies Section -->
        <section id="sectionMovies" style="display: none;">
            <h2 class="section-title">üé¨ Pel√≠culas</h2>
            <div class="grid" id="gridMovies"></div>
        </section>

        <!-- Series Section -->
        <section id="sectionSeries" style="display: none;">
            <h2 class="section-title">üì∫ Series</h2>
            <div class="grid" id="gridSeries"></div>
        </section>
    </main>

    <!-- Modal -->
    <div class="modal-bg" id="modal">
        <div class="modal">
            <button class="modal-close" onclick="cerrarModal()">√ó</button>
            <div id="modalBackdrop"></div>
            <div class="modal-body">
                <div class="modal-header">
                    <img id="modalPoster" class="modal-poster" src="" alt="">
                    <div class="modal-info">
                        <h2 id="modalTitle"></h2>
                        <div class="modal-meta" id="modalMeta"></div>
                        <div class="modal-genres" id="modalGenres"></div>
                        <button id="modalWatchBtn" class="watch-btn" style="display:none;">
                            ‚ñ∂Ô∏è Ver Ahora en Telegram
                        </button>
                    </div>
                </div>
                <p class="modal-overview" id="modalOverview"></p>
            </div>
        </div>
    </div>

    <script>
        // Usa la Netlify Function para obtener datos
        const API_URL = '/.netlify/functions/get-catalog';
        let peliculas = [];
        let series = [];
        let botUsername = 'CineStelar_bot';
        let tabActual = 'all';

        // Al cargar
        window.onload = () => {
            cargarDatos();

            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.onclick = () => cambiarTab(btn.dataset.tab);
            });

            document.getElementById('search').oninput = () => renderizar();
        };

        // Cargar datos desde Netlify Function
        async function cargarDatos() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('empty').style.display = 'none';
            document.getElementById('sectionMovies').style.display = 'none';
            document.getElementById('sectionSeries').style.display = 'none';

            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error('Error al cargar datos');
                
                const data = await response.json();
                
                peliculas = data.movies || [];
                series = data.series || [];
                botUsername = data.bot_username || 'CineStelar_bot';
                
                console.log('‚úÖ Pel√≠culas:', peliculas.length);
                console.log('‚úÖ Series:', series.length);
                console.log('‚úÖ Bot:', botUsername);

                // Actualizar contadores
                document.getElementById('countMovies').textContent = peliculas.length;
                document.getElementById('countSeries').textContent = series.length;
                document.getElementById('countAll').textContent = peliculas.length + series.length;

                document.getElementById('loading').style.display = 'none';
                renderizar();

            } catch (error) {
                console.error('‚ùå Error:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('empty').innerHTML = `
                    <div class="empty-icon">‚ùå</div>
                    <h3>Error de conexi√≥n</h3>
                    <p>${error.message}</p>
                `;
                document.getElementById('empty').style.display = 'block';
            }
        }

        // Generar deep link
        function generarDeepLink(tipo, id) {
            return `https://t.me/${botUsername}?start=${tipo}_${id}`;
        }

        // Cambiar tab
        function cambiarTab(tab) {
            tabActual = tab;
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            document.querySelector(`.nav-item[data-tab="${tab}"]`).classList.add('active');
            renderizar();
        }

        // Renderizar
        function renderizar() {
            const query = document.getElementById('search').value.toLowerCase().trim();

            let moviesFiltradas = peliculas.filter(p => {
                const titulo = (p.title || p.original_title || '').toLowerCase();
                return titulo.includes(query);
            });

            let seriesFiltradas = series.filter(s => {
                const titulo = (s.name || s.original_name || '').toLowerCase();
                return titulo.includes(query);
            });

            const hayPelis = moviesFiltradas.length > 0;
            const haySeries = seriesFiltradas.length > 0;

            // Mostrar secciones seg√∫n tab
            const mostrarPelis = tabActual === 'all' || tabActual === 'movies';
            const mostrarSeries = tabActual === 'all' || tabActual === 'series';

            document.getElementById('sectionMovies').style.display = (mostrarPelis && hayPelis) ? 'block' : 'none';
            document.getElementById('sectionSeries').style.display = (mostrarSeries && haySeries) ? 'block' : 'none';

            if (mostrarPelis) {
                document.getElementById('gridMovies').innerHTML = moviesFiltradas.map(cardPelicula).join('');
            }
            if (mostrarSeries) {
                document.getElementById('gridSeries').innerHTML = seriesFiltradas.map(cardSerie).join('');
            }

            // Empty state
            const noResultados = (!mostrarPelis || !hayPelis) && (!mostrarSeries || !haySeries);
            document.getElementById('empty').style.display = noResultados ? 'block' : 'none';
        }

        // Card pel√≠cula
        function cardPelicula(p) {
            const titulo = p.title || p.original_title || 'Sin t√≠tulo';
            const rating = p.vote_average ? (p.vote_average / 10).toFixed(1) : '';
            const tituloEscaped = titulo.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            
            const imgHtml = p.poster_url
                ? `<img class="card-poster" src="${p.poster_url}" alt="${tituloEscaped}" loading="lazy" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
                   <div class="card-placeholder" style="display:none;"><div class="card-placeholder-icon">üé¨</div><div class="card-placeholder-title">${tituloEscaped}</div></div>`
                : `<div class="card-placeholder"><div class="card-placeholder-icon">üé¨</div><div class="card-placeholder-title">${tituloEscaped}</div></div>`;

            return `
                <div class="card" onclick="verPelicula(${p.id})">
                    <span class="card-badge badge-movie">Pel√≠cula</span>
                    ${imgHtml}
                    <div class="card-overlay">
                        <div class="card-title">${titulo}</div>
                        <div class="card-meta">
                            ${p.year ? `<span>${p.year}</span>` : ''}
                            ${rating ? `<span class="rating">‚≠ê ${rating}</span>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Card serie
        function cardSerie(s) {
            const titulo = s.name || s.original_name || 'Sin t√≠tulo';
            const rating = s.vote_average ? s.vote_average.toFixed(1) : '';
            const tituloEscaped = titulo.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            
            const imgHtml = s.poster_url
                ? `<img class="card-poster" src="${s.poster_url}" alt="${tituloEscaped}" loading="lazy" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
                   <div class="card-placeholder" style="display:none;"><div class="card-placeholder-icon">üì∫</div><div class="card-placeholder-title">${tituloEscaped}</div></div>`
                : `<div class="card-placeholder"><div class="card-placeholder-icon">üì∫</div><div class="card-placeholder-title">${tituloEscaped}</div></div>`;

            return `
                <div class="card" onclick="verSerie(${s.id})">
                    <span class="card-badge badge-series">Serie</span>
                    ${imgHtml}
                    <div class="card-overlay">
                        <div class="card-title">${titulo}</div>
                        <div class="card-meta">
                            ${s.year ? `<span>${s.year}</span>` : ''}
                            ${rating ? `<span class="rating">‚≠ê ${rating}</span>` : ''}
                            ${s.number_of_seasons ? `<span>${s.number_of_seasons} temp.</span>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Ver pel√≠cula
        function verPelicula(id) {
            const p = peliculas.find(x => x.id === id);
            if (!p) return;

            const titulo = p.title || p.original_title || 'Sin t√≠tulo';
            
            document.getElementById('modalBackdrop').innerHTML = p.backdrop_url
                ? `<img class="modal-backdrop" src="${p.backdrop_url}" alt="">`
                : `<div class="modal-backdrop-placeholder">üé¨</div>`;

            const poster = document.getElementById('modalPoster');
            if (p.poster_url) {
                poster.src = p.poster_url;
                poster.style.display = 'block';
            } else {
                poster.style.display = 'none';
            }

            document.getElementById('modalTitle').textContent = titulo;

            let meta = '';
            if (p.year) meta += `<span>üìÖ ${p.year}</span>`;
            if (p.runtime) meta += `<span>‚è±Ô∏è ${p.runtime} min</span>`;
            if (p.vote_average) meta += `<span class="rating">‚≠ê ${(p.vote_average/10).toFixed(1)}/10</span>`;
            document.getElementById('modalMeta').innerHTML = meta;

            let genres = '';
            if (p.genres) {
                genres = p.genres.split(',').map(g => `<span class="genre-tag">${g.trim()}</span>`).join('');
            }
            document.getElementById('modalGenres').innerHTML = genres;

            document.getElementById('modalOverview').textContent = p.overview || 'Sin descripci√≥n disponible.';

            // Bot√≥n Ver Ahora - usa message_id si existe, sino usa id
            const watchBtn = document.getElementById('modalWatchBtn');
            const videoId = p.message_id || p.id;
            const deepLink = generarDeepLink('video', videoId);
            watchBtn.style.display = 'inline-flex';
            watchBtn.onclick = () => window.open(deepLink, '_blank');

            document.getElementById('modal').classList.add('show');
        }

        // Ver serie
        function verSerie(id) {
            const s = series.find(x => x.id === id);
            if (!s) return;

            const titulo = s.name || s.original_name || 'Sin t√≠tulo';
            
            document.getElementById('modalBackdrop').innerHTML = s.backdrop_url
                ? `<img class="modal-backdrop" src="${s.backdrop_url}" alt="">`
                : `<div class="modal-backdrop-placeholder">üì∫</div>`;

            const poster = document.getElementById('modalPoster');
            if (s.poster_url) {
                poster.src = s.poster_url;
                poster.style.display = 'block';
            } else {
                poster.style.display = 'none';
            }

            document.getElementById('modalTitle').textContent = titulo;

            let meta = '';
            if (s.year) meta += `<span>üìÖ ${s.year}</span>`;
            if (s.number_of_seasons) meta += `<span>üì∫ ${s.number_of_seasons} temporadas</span>`;
            if (s.vote_average) meta += `<span class="rating">‚≠ê ${s.vote_average.toFixed(1)}/10</span>`;
            if (s.status) meta += `<span>üìä ${s.status}</span>`;
            document.getElementById('modalMeta').innerHTML = meta;

            let genres = '';
            if (s.genres) {
                genres = s.genres.split(',').map(g => `<span class="genre-tag">${g.trim()}</span>`).join('');
            }
            document.getElementById('modalGenres').innerHTML = genres;

            document.getElementById('modalOverview').textContent = s.overview || 'Sin descripci√≥n disponible.';

            // Bot√≥n Ver Ahora
            const watchBtn = document.getElementById('modalWatchBtn');
            const deepLink = generarDeepLink('series', s.id);
            watchBtn.style.display = 'inline-flex';
            watchBtn.onclick = () => window.open(deepLink, '_blank');

            document.getElementById('modal').classList.add('show');
        }

        // Cerrar modal
        function cerrarModal() {
            document.getElementById('modal').classList.remove('show');
        }

        document.getElementById('modal').onclick = (e) => {
            if (e.target.id === 'modal') cerrarModal();
        };
        document.onkeydown = (e) => {
            if (e.key === 'Escape') cerrarModal();
        };
    </script>
</body>
</html>
